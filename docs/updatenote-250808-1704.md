# Update Notes – August 8, 2025 17:04

## Overview

This update strengthens password hashing, enables at‑rest AES‑GCM encryption for JSON stores, fixes DI wiring for decorators, aligns metrics usage, unifies tests on NUnit for the Web project, and adds a Windows CI pipeline that skips IIS‑dependent builds.

## 🔐 Security & Hashing

- Default algorithm remains **BCrypt** with configurable work factor
  - `src/Core/Security/IPasswordHasher.cs` → configurable `PasswordHasherService`
  - DI now passes `HashingConfig` values
- Added **Argon2id** support (PHC format) via `Konscious.Security.Cryptography`
  - `src/Core/Security/PasswordHasher.cs`: `HashPasswordArgon2(...)`, `VerifyArgon2(...)`, detection of `$argon2i$|$argon2d$|$argon2id$`
  - NuGet: `Konscious.Security.Cryptography.Argon2` (MIT) — see `src/Core/Core.csproj`
  - Reference: https://github.com/kmaragon/Konscious.Security.Cryptography
- Salt persistence policy clarified
  - For BCrypt/Argon2, salt embedded in hash (store empty salt)
  - For PBKDF2, generate and persist Base64 salt
  - `src/Core/Tools/UserManagerService.cs` updated to use `HashPassword(..., out salt)`

## 🔒 At‑Rest Encryption (AES‑256‑GCM)

- New `EncryptedJsonUserStore` that decrypts on load and encrypts on save
  - `src/Core/Stores/EncryptedJsonUserStore.cs` (hot‑reload + atomic writes)
  - Uses `FileEncryption` AES‑GCM with key from `UserStore.EncryptionKeyEnv`; DPAPI fallback if not set
- Factory/DI wiring selects encrypted store when `EncryptionKeyEnv` is configured
  - `src/AuthProvider/UserStoreFactory.cs`
  - `src/ManagementWeb/App_Start/UnityConfig.cs`

## 🧩 Dependency Injection (Unity) Improvements

- Fixed decorator registration to avoid recursive `IUserStore` resolution
  - Inner store now registered with name `"InnerUserStore"`; default `IUserStore` is `InstrumentedUserStore` wrapping the named inner
- `IPasswordHasher` registered via factory using config (algorithm/iterations; BCrypt cost default; Argon2 defaults set)
- `IAuditLogger`/`IMetricsCollector` registered via factories with config‑driven parameters
  - File: `src/ManagementWeb/App_Start/UnityConfig.cs`

## 📊 Metrics & Health

- Aligned Web health metrics with actual counter names
  - `ftp_auth_success_total` / `ftp_auth_failure_total`
  - File: `src/ManagementWeb/Services/ApplicationServices.cs`

## 🧪 Testing

- Unify `ManagementWeb.Tests` on **NUnit** (Core/AuthProvider already on NUnit)
  - `tests/ManagementWeb.Tests/ManagementWeb.Tests.csproj`
  - `tests/ManagementWeb.Tests/Services/ApplicationServicesTests.cs`

## ⚙️ CI/CD

- Added GitHub Actions workflow for Windows builds/tests
  - Path: `.github/workflows/ci.yml`
  - Builds: Core, ManagementWeb, ManagementCli
  - Tests: Core.Tests, ManagementWeb.Tests
  - Skips: AuthProvider build/tests (depends on `Microsoft.Web.FtpServer`)

## 📚 Docs Updates

- `docs/codebase-summary.md`: note BCrypt default + planned Argon2
- `docs/design.md`: BCrypt default, AES‑256‑GCM at rest, Argon2 planned
- `docs/improvement-roadmap.md`: clarify Argon2 plan and link

## 🎯 Impact

- Stronger password hashing options with backward compatibility
- Encrypted JSON store supported at runtime, not just via CLI
- More robust DI wiring and metric usage
- CI coverage on Windows without IIS dependency blockers

## 🔍 Verification Steps

1. Build
   - `dotnet build src/Core/Core.csproj -c Release`
   - `dotnet build src/ManagementWeb/ManagementWeb.csproj -c Release`
   - `dotnet build src/ManagementCli/ManagementCli.csproj -c Release`
2. Tests
   - `dotnet test tests/Core.Tests/Core.Tests.csproj -c Release`
   - `dotnet test tests/ManagementWeb.Tests/ManagementWeb.Tests.csproj -c Release`
3. Encrypted store
   - Set `FTP_USERS_KEY` to a Base64 32‑byte key; configure `UserStore:EncryptionKeyEnv` & `UserStore:Path`
   - Verify users load/save and hot‑reload works

---

Document created: 2025‑08‑08 17:04


